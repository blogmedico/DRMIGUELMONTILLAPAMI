<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Convertidor NotebookLM → HTML (Mostrar + Descargar)</title>
<link rel="preload" href="https://cdn.jsdelivr.net/npm/marked/marked.min.js" as="script">
<style>
  :root{
    --bg:#f4f7fa; --card:#fff; --accent:#0b6b8a; --muted:#556069;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:var(--bg); margin:0; color:#081214}
  header{background:linear-gradient(90deg,#eaf6fa,#fbfeff);padding:16px;border-bottom:1px solid rgba(11,107,138,.06)}
  .wrap{max-width:1100px;margin:18px auto;padding:0 16px}
  h1{margin:0;color:var(--accent);font-size:20px}
  p.lead{margin:6px 0 0;color:var(--muted)}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:18px}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 8px 28px rgba(2,6,8,0.04)}
  label{display:block;font-weight:700;margin-bottom:6px}
  .small{font-size:13px;color:var(--muted)}
  input[type=file]{width:100%}
  textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef2;resize:vertical}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{background:var(--accent);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:#eef7fa;color:var(--accent);border:1px solid rgba(11,107,138,0.08)}
  .preview{min-height:420px;overflow:auto;padding:18px;border-radius:8px;border:1px solid rgba(11,26,33,0.04);background:#fff}
  /* Output clinical style */
  .out{font-family:Georgia, 'Times New Roman', serif;color:#072431;max-width:900px;margin:0 auto}
  .out h1{font-size:22px;color:var(--accent);margin:6px 0}
  .out h2{font-size:18px;color:#0b4a6f;margin:10px 0}
  .out p{margin:8px 0;line-height:1.5}
  .out img{max-width:100%;height:auto;border-radius:6px;margin:8px 0}
  .meta{font-size:13px;color:var(--muted);margin-bottom:12px}
  pre{background:#f6f8fa;padding:10px;border-radius:8px;overflow:auto}
  footer{max-width:1100px;margin:18px auto;padding:12px 16px;color:var(--muted);font-size:13px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Convertidor NotebookLM → HTML</h1>
    <p class="lead">Subí o pegá tu trabajo. Se mostrará en pantalla y se podrá descargar como HTML clínico, limpio y continuo. (Acepta .txt .md .docx .pdf e imágenes)</p>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <aside>
      <div class="card">
        <div>
          <label for="file">1) Subí archivos (o arrastrá)</label>
          <input id="file" type="file" multiple accept=".md,.markdown,.txt,.html,.htm,.docx,.pdf,image/*">
          <div class="small" style="margin-top:8px">También podés pegar en el cuadro de abajo y presionar <strong>Convertir pegado</strong>.</div>
        </div>

        <div style="margin-top:12px">
          <label for="paste">2) O pegá tu contenido (Markdown / Texto / HTML)</label>
          <textarea id="paste" rows="7" placeholder="Pegá aquí el texto exportado desde NotebookLM..."></textarea>
          <div class="controls" style="margin-top:8px">
            <button id="btnConvertPaste">Convertir pegado</button>
            <button id="btnClear" class="secondary">Borrar</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>Opciones</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <label class="small"><input id="optResize" type="checkbox" checked> Redimensionar imágenes grandes (&gt;1000px)</label>
            <label class="small"><input id="optEmbed" type="checkbox"> Incrustar imágenes (base64)</label>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="controls">
            <button id="btnProcess">Procesar archivos</button>
            <button id="btnShowRaw" class="secondary">Mostrar HTML crudo</button>
            <button id="btnDownload" class="secondary">Descargar HTML</button>
          </div>
          <div id="status" class="small" style="margin-top:8px;color:var(--muted)"></div>
        </div>
      </div>
    </aside>

    <section>
      <div class="card preview" id="preview">
        <div class="small" style="color:var(--muted)">Aún no se procesó contenido. Subí o pegá tu trabajo.</div>
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap small">Hecho rápido y sin vueltas. HTML descargable incluido.</div>
</footer>

<!-- Librerías necesarias -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js"></script>

<script>
const fileInput = document.getElementById('file');
const pasteBox = document.getElementById('paste');
const btnConvertPaste = document.getElementById('btnConvertPaste');
const btnClear = document.getElementById('btnClear');
const btnProcess = document.getElementById('btnProcess');
const btnShowRaw = document.getElementById('btnShowRaw');
const btnDownload = document.getElementById('btnDownload');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
const optResize = document.getElementById('optResize');
const optEmbed = document.getElementById('optEmbed');

let lastHTML = '';
let queuedFiles = [];

/* Helpers */
function setStatus(s){ status.textContent = s; }
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* Resize image via canvas -> returns DataURL */
async function resizeImage(file, maxDim=1000){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> {
      const img = new Image();
      img.onload = ()=>{
        let w = img.width, h = img.height;
        const max = Math.max(w,h);
        if(max <= maxDim){ res(fr.result); return; }
        const scale = maxDim / max;
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(w*scale);
        canvas.height = Math.round(h*scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        canvas.toBlob(blob=>{
          const rfr = new FileReader();
          rfr.onload = ()=> res(rfr.result);
          rfr.readAsDataURL(blob);
        }, 'image/jpeg', 0.78);
      };
      img.onerror = e => rej(e);
      img.src = fr.result;
    };
    fr.onerror = e => rej(e);
    fr.readAsDataURL(file);
  });
}

/* Process a single File object */
async function processFile(file){
  const name = file.name || 'pegado';
  const suf = (file.name || '').split('.').pop().toLowerCase();
  setStatus('Procesando: ' + name);
  // text-like
  if(file.type.startsWith('text/') || ['txt','md','markdown','csv'].includes(suf)){
    const txt = await file.text();
    return {name, html: convertTextOrMarkdown(txt)};
  }
  // html
  if(file.type === 'text/html' || ['html','htm'].includes(suf)){
    return {name, html: await file.text()};
  }
  // docx (mammoth)
  if(['docx'].includes(suf) || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'){
    try{
      const ab = await file.arrayBuffer();
      const result = await mammoth.convertToHtml({arrayBuffer:ab});
      return {name, html: result.value};
    }catch(e){
      return {name, html: `<p>Error convirtiendo DOCX: ${escapeHtml(e.message)}</p>`};
    }
  }
  // pdf (pdf.js)
  if(file.type === 'application/pdf' || suf === 'pdf'){
    try{
      const ab = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data:ab}).promise;
      let out = '';
      for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const text = content.items.map(it=>it.str).join(' ');
        out += `<p>${escapeHtml(text)}</p>`;
      }
      return {name, html: out};
    }catch(e){
      return {name, html: `<p>Error extrayendo texto PDF: ${escapeHtml(e.message)}</p>`};
    }
  }
  // images
  if(file.type.startsWith('image/') || ['png','jpg','jpeg','gif','webp'].includes(suf)){
    try{
      let dataUrl = optResize.checked ? await resizeImage(file, 1000) : await new Promise(res=>{
        const r = new FileReader(); r.onload = ()=> res(r.result); r.readAsDataURL(file);
      });
      if(optEmbed.checked){
        return {name, html: `<div><img src="${dataUrl}" alt="${escapeHtml(name)}"></div>`};
      } else {
        const url = URL.createObjectURL(file);
        return {name, html: `<div><img src="${url}" alt="${escapeHtml(name)}"></div>` , blobRef: file};
      }
    }catch(e){
      return {name, html: `<p>Error procesando imagen: ${escapeHtml(e.message)}</p>`};
    }
  }
  // fallback
  try{
    const txt = await file.text();
    return {name, html: convertTextOrMarkdown(txt)};
  }catch(e){
    return {name, html: `<p>No soportado: ${escapeHtml(name)}</p>`};
  }
}

/* Convert markdown or plain text to HTML */
function convertTextOrMarkdown(txt){
  const looksLikeMd = /(^#|\n#|\*\*|\* |`|^- )/m.test(txt);
  if(looksLikeMd){
    try { return marked.parse(txt); } catch(e) { return `<pre>${escapeHtml(txt)}</pre>`; }
  }
  return txt.split(/\n\n+/).map(p => `<p>${escapeHtml(p).replace(/\n/g,' ')}</p>`).join("\n");
}

/* Build final HTML */
function buildAndShow(items){
  const title = items.length === 1 ? items[0].name : 'Trabajo convertido';
  const body = items.map(it => `<section><h2>${escapeHtml(it.name)}</h2>${it.html}</section>`).join('<hr/>');
  const html = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${escapeHtml(title)}</title>
  <style>body{font-family:Georgia,serif;color:#072431;padding:18px;background:#f8fbfc} .container{max-width:900px;margin:0 auto;background:#fff;padding:22px;border-radius:8px;box-shadow:0 8px 30px rgba(2,6,8,0.06)} h1{color:#0b6b8a} h2{color:#0b4a6f} p{line-height:1.5}</style>
  </head><body><div class="container"><h1>${escapeHtml(title)}</h1><div class="meta" style="font-size:13px;color:#556069;margin-bottom:10px">Generado: ${new Date().toLocaleString()}</div>${body}</div></body></html>`;
  preview.innerHTML = html;
  lastHTML = html;
}

/* ---------- UI events ---------- */
btnConvertPaste.addEventListener('click', ()=>{
  const txt = pasteBox.value.trim();
  if(!txt){ alert('Pegá algo primero.'); return; }
  setStatus('Convirtiendo pegado...');
  const html = convertTextOrMarkdown(txt);
  buildAndShow([{name:'Pegado desde NotebookLM', html}]);
  setStatus('Listo.');
});

btnClear.addEventListener('click', ()=>{
  pasteBox.value = '';
  preview.innerHTML = '<div class="small" style="color:#556069">Aún no se procesó contenido. Subí o pegá tu trabajo.</div>';
  lastHTML = '';
  queuedFiles = [];
  fileInput.value = '';
  setStatus('Borrado.');
});

fileInput.addEventListener('change', (e)=>{
  queuedFiles = Array.from(e.target.files);
  setStatus(queuedFiles.length + ' archivo(s) listos para procesar.');
});

// drag & drop
['dragenter','dragover'].forEach(ev => window.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
window.addEventListener('drop', e => {
  e.preventDefault(); e.stopPropagation();
  if(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length){
    queuedFiles = Array.from(e.dataTransfer.files);
    setStatus(queuedFiles.length + ' archivo(s) agregados (arrastrados).');
  }
});

btnProcess.addEventListener('click', async ()=>{
  const files = queuedFiles.length ? queuedFiles : (fileInput.files ? Array.from(fileInput.files) : []);
  if(files.length === 0){ alert('Subí o arrastrá archivos primero.'); return; }
  setStatus('Procesando ' + files.length + ' archivo(s)...');
  const out = [];
  for(let f of files){
    const r = await processFile(f);
    out.push(r);
  }
  buildAndShow(out);
  setStatus('Procesamiento terminado. Mostrando en pantalla.');
});

btnShowRaw.addEventListener('click', ()=>{
  if(!lastHTML){ alert('No hay HTML generado aún.'); return; }
  const w = window.open();
  w.document.write(lastHTML);
  w.document.close();
});

/* NUEVO: Descargar HTML */
btnDownload.addEventListener('click', ()=>{
  if(!lastHTML){ alert('No hay HTML generado aún.'); return; }
  const blob = new Blob([lastHTML], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'resumen.html';
  a.click();
  URL.revokeObjectURL(url);
});

/* expose quick function if NotebookLM copies JSON or string */
window.convertNotebookString = s => {
  pasteBox.value = s;
  btnConvertPaste.click();
};

/* pdf.js worker */
if(window.pdfjsLib && !pdfjsLib.GlobalWorkerOptions.workerSrc){
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
}

</script>
</body>
</html>
